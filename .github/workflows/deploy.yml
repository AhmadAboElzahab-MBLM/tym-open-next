name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - staging

jobs:
  setup-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lang: [en, en-us, ko, en-ko, de]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "prefix=production-tym" >> $GITHUB_OUTPUT
            echo "name=production" >> $GITHUB_OUTPUT
          else
            echo "prefix=staging-tym" >> $GITHUB_OUTPUT
            echo "name=staging" >> $GITHUB_OUTPUT
          fi

      - name: Set worker and bucket names
        id: names
        env:
          ENV_PREFIX: ${{ steps.env.outputs.prefix }}
        run: |
          echo "worker=${ENV_PREFIX}-${{ matrix.lang }}" >> $GITHUB_OUTPUT
          echo "bucket=${ENV_PREFIX}-cache-${{ matrix.lang }}" >> $GITHUB_OUTPUT

      - name: Create R2 bucket if not exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸ“¦ Checking R2 bucket: ${{ steps.names.outputs.bucket }}"

          # Check if bucket exists
          if npx wrangler r2 bucket list 2>/dev/null | grep -q "${{ steps.names.outputs.bucket }}"; then
            echo "   âœ… Bucket already exists"
          else
            echo "   Creating bucket..."
            npx wrangler r2 bucket create ${{ steps.names.outputs.bucket }}
            echo "   âœ… Bucket created"
          fi

      - name: Build and Deploy Worker
        env:
          # Cloudflare credentials
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          # R2 credentials
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

          # Language and worker settings
          NEXT_PUBLIC_LANG: ${{ matrix.lang }}
          WORKER_NAME: ${{ steps.names.outputs.worker }}
          BUCKET_NAME: ${{ steps.names.outputs.bucket }}

          # Umbraco endpoints
          NEXT_PUBLIC_UMBRACO_BASE_IMAGE_URL:
            ${{ github.ref == 'refs/heads/main' && secrets.PRODUCTION_UMBRACO_BASE_IMAGE_URL ||
            secrets.STAGING_UMBRACO_BASE_IMAGE_URL }}
          NEXT_PUBLIC_UMBRACO_ENDPOINT:
            ${{ github.ref == 'refs/heads/main' && secrets.PRODUCTION_UMBRACO_ENDPOINT ||
            secrets.STAGING_UMBRACO_ENDPOINT }}

          # Shared API keys
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          NEXT_PUBLIC_HUBSPOT_API_KEY: ${{ secrets.NEXT_PUBLIC_HUBSPOT_API_KEY }}
          HUBSPOT_TOKEN: ${{ secrets.HUBSPOT_TOKEN }}
          NEXT_PUBLIC_HUBSPOT_DEALERS_URL: ${{ secrets.NEXT_PUBLIC_HUBSPOT_DEALERS_URL }}
          NEXT_PUBLIC_UMBRACO_API_KEY: ${{ secrets.NEXT_PUBLIC_UMBRACO_API_KEY }}
          NEXT_PUBLIC_UMBRACO_SEARCH_API: ${{ secrets.NEXT_PUBLIC_UMBRACO_SEARCH_API }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Building and Deploying"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   Language:    ${{ matrix.lang }}"
          echo "   Environment: ${{ steps.env.outputs.name }}"
          echo "   Worker:      ${{ steps.names.outputs.worker }}"
          echo "   Bucket:      ${{ steps.names.outputs.bucket }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          npm run deploy

      - name: Set Worker Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸ” Setting secrets for: ${{ steps.names.outputs.worker }}"

          echo "${{ secrets.R2_ACCESS_KEY_ID }}" | npx wrangler secret put R2_ACCESS_KEY_ID --name ${{ steps.names.outputs.worker }}
          echo "${{ secrets.R2_SECRET_ACCESS_KEY }}" | npx wrangler secret put R2_SECRET_ACCESS_KEY --name ${{ steps.names.outputs.worker }}
          echo "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" | npx wrangler secret put CLOUDFLARE_ACCOUNT_ID --name ${{ steps.names.outputs.worker }}
          echo "${{ secrets.NEXT_PUBLIC_HUBSPOT_API_KEY }}" | npx wrangler secret put NEXT_PUBLIC_HUBSPOT_API_KEY --name ${{ steps.names.outputs.worker }}
          echo "${{ secrets.HUBSPOT_TOKEN }}" | npx wrangler secret put HUBSPOT_TOKEN --name ${{ steps.names.outputs.worker }}
          echo "${{ secrets.NEXT_PUBLIC_UMBRACO_API_KEY }}" | npx wrangler secret put NEXT_PUBLIC_UMBRACO_API_KEY --name ${{ steps.names.outputs.worker }}

          echo "   âœ… All secrets set"

      - name: Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   Language:    ${{ matrix.lang }}"
          echo "   Environment: ${{ steps.env.outputs.name }}"
          echo "   Worker:      ${{ steps.names.outputs.worker }}"
          echo "   URL:         https://${{ steps.names.outputs.worker }}.workers.dev"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
